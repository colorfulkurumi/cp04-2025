<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
  <script src="components/loader.js"></script>
  <script src="lib/onsenui/js/onsenui.min.js"></script>
  <link rel="stylesheet" href="components/loader.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsenui.css">
  <link rel="stylesheet" href="lib/onsenui/css/onsen-css-components.css">
  <link rel="stylesheet" href="css/style.css">
  <style>

  </style>
  <script>
    // timer処理
    $(function(){
        setInterval(function(){
            timer();
        },500);
    });  
      
    // ready クリックの処理の登録
    $(function() { 
        $('#date').click(function(e) {
            setDebugMode(e);
        });
      
        $('#btnA').click(function(e) {
            btnAClick(e);
        });


        $('#btnC').click(function(e) {
            btnCClick(e);
        });
        init();
    });
    
    function rgbToColor(r,g,b){
        return "#" + hex02(r)+hex02(g)+hex02(b);
    }
    
    function hex02(x) {
        var str = "0"+x.toString(16);
        return str.substring(str.length-2);
    }
    
    function decS2(x) {
        if (x<10) {
            return "&nbsp;"+x.toString(10);
        } else { 
            return x.toString(10);
        }
    }
    
    function dec02(x) {
        var str = "0"+x.toString(10);
        return str.substring(str.length-2);        
    }

    var debug = false;
    // Statusがクリックされた時の処理
    function setDebugMode(e){
        debug = !debug;
        $("#status").html("Debug Mode: "+debug);
    }
    
    // 座標を計算
    // getX(中心x座標,角度(1で一周),長さ(1で最大)
    function getX(cx,d,r){
        return cx + Math.sin(d*2*3.14)*cx*r;
    }
    // getY(中心y座標,角度(1で一周),長さ(1で最大)
    function getY(cy,d,r){
        return cy - Math.cos(d*2*3.14)*cy*r;
    }
    // 線を描く
    // line(context,x1,y1,x2,y2,線の太さ,色)    
    function line(ctx,x1,y1,x2,y2,width,color){
        ctx.lineWidth = width; 
        ctx.lineCap = "round"; 
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();        
    }    
    // 時計 clock(時, 分, 秒, 残り時間が短い時に不要な針を隠す)
    function clock(hour,minute,second,hide){
        var canvas = $('#mycanvas')[0];
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; 
        ctx.fillRect(0,0,canvas.width,canvas.height);
        var cx = canvas.width/2;
        var cy = canvas.height/2;
        var ds = second/60;
        var dm = (minute+ds)/60;
        var dh = (hour%12+dm)/12;

        for(var i = 0; i < 60; i++) {
            var px = getX(cx,i/60,0.9);
            var py = getY(cy,i/60,0.9);
            ctx.fillStyle = 'rgb(0, 255, 0)'; 
            ctx.beginPath();
            ctx.arc(px, py, 2, 0, Math.PI*2, false);
            ctx.fill();
        }
        
        for(var i = 0; i < 12; i++) {
            var px = getX(cx,i/12,0.9);
            var py = getY(cy,i/12,0.9);
            ctx.fillStyle = 'rgb(255, 255, 0)'; 
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI*2, false);
            ctx.fill();
        }

        if ((!hide) || hour > 0) {
            var px = getX(cx,dh,0.4);
            var py = getY(cy,dh,0.4);
            line(ctx,cx,cy,px,py,20, 'rgb(255, 100, 162)')
        }
        if ((!hide) || hour > 0|| minute > 0) {
            var px = getX(cx,dm,0.6);
            var py = getY(cy,dm,0.6);
            line(ctx,cx,cy,px,py,15, 'rgb(128, 255, 162)')
        }
        var px = getX(cx,ds,0.9);
        var py = getY(cy,ds,0.9);
        line(ctx,cx,cy,px,py,5, 'rgb(128, 100, 255)')
    }

    // 残り秒数アナログ表示
    function analog(rest){
        var h = parseInt(rest/3600);
        var m = parseInt((rest-h*3600)/60);
        var s = parseInt(rest-h*3600-m*60);
        clock(h,m,s,true);

        var maxCircles = 60;
        var lang = languages[currentLanguage];
        var hstr = lang.hourCircle + "〇".repeat(Math.min(h, maxCircles));
        var mstr = lang.minuteCircle + "〇".repeat(Math.min(m, maxCircles));
        var sstr = lang.secondCircle + "〇".repeat(Math.min(s, maxCircles));

        $("#hourStr").html(hstr);
        $("#minuteStr").html(mstr);
        $("#secondStr").html(sstr);
    }



// これより上は編集しなくて良い


    // 変数宣言
    var buttonState = 'idle'; // 'idle', 'running', 'paused'
    var currentLanguage = 'en'; // 'zh', 'ja', 'en'

    // 多言語対応
    var languages = {
        zh: {
            buttonStart: '开始',
            buttonPause: '暂停',
            buttonResume: '继续',
            buttonSet: '设置',
            elapsedTime: '经过时间：',
            remainingTime: '剩余时间：',
            hourUnit: '时',
            minuteUnit: '分',
            secondUnit: '秒',
            hourCircle: '时：',
            minuteCircle: '分：',
            secondCircle: '秒：',
            languageName: '中文'
        },
        ja: {
            buttonStart: '開始',
            buttonPause: '一時停止',
            buttonResume: '再開',
            buttonSet: 'セット',
            elapsedTime: '経過時間：',
            remainingTime: '残り時間：',
            hourUnit: '時',
            minuteUnit: '分',
            secondUnit: '秒',
            hourCircle: '時：',
            minuteCircle: '分：',
            secondCircle: '秒：',
            languageName: '日本語'
        },
        en: {
            buttonStart: 'Start',
            buttonPause: 'Pause',
            buttonResume: 'Resume',
            buttonSet: 'Set',
            elapsedTime: 'Elapsed Time: ',
            remainingTime: 'Remaining Time: ',
            hourUnit: 'h',
            minuteUnit: 'm',
            secondUnit: 's',
            hourCircle: 'Hours: ',
            minuteCircle: 'Minutes: ',
            secondCircle: 'Seconds: ',
            languageName: 'English'
        }
    };

    // localStorageから保存された時間を読み込む
    function loadSavedTime() {
        try {
            var savedHour = localStorage.getItem('timer_hour');
            var savedMinute = localStorage.getItem('timer_minute');
            var savedSecond = localStorage.getItem('timer_second');

            if (savedHour !== null) {
                $('#hour').val(savedHour);
            }
            if (savedMinute !== null) {
                $('#minute').val(savedMinute);
            }
            if (savedSecond !== null) {
                $('#second').val(savedSecond);
            }
        } catch (e) {
            // localStorageが利用できない場合の処理
            console.log('localStorage is not available');
        }
    }

    // 現在の時間をlocalStorageに保存
    function saveTimeToStorage() {
        try {
            localStorage.setItem('timer_hour', $('#hour').val());
            localStorage.setItem('timer_minute', $('#minute').val());
            localStorage.setItem('timer_second', $('#second').val());
        } catch (e) {
            // localStorageが利用できない場合の処理
            console.log('localStorage is not available');
        }
    }

    // 入力値の検証と修正
    function validateInput(inputId, min, max) {
        var input = $('#' + inputId);
        var value = parseInt(input.val());

        // 空值或NaN的情况，设为最小值
        if (isNaN(value) || input.val() === '') {
            input.val(min);
            return;
        }

        // 超出范围的情况，修正到有效范围
        if (value < min) {
            input.val(min);
        } else if (value > max) {
            input.val(max);
        }
    }

    // 小时输入验证（0-11）
    function validateHour() {
        validateInput('hour', 0, 11);
    }

    // 分钟和秒输入验证（0-59）
    function validateMinute() {
        validateInput('minute', 0, 59);
    }

    function validateSecond() {
        validateInput('second', 0, 59);
    }

    // ボタンの文案を更新
    function updateButtonText() {
        var lang = languages[currentLanguage];
        if (buttonState === 'idle') {
            $('#btnA').text(lang.buttonStart);
        } else if (buttonState === 'running') {
            $('#btnA').text(lang.buttonPause);
        } else if (buttonState === 'paused') {
            $('#btnA').text(lang.buttonResume);
        }
    }

    // 言語を切り替え
    function changeLanguage(lang) {
        currentLanguage = lang;
        updateAllTexts();
        updateButtonText();
    }

    // すべてのテキストを更新
    function updateAllTexts() {
        var lang = languages[currentLanguage];

        // ボタン更新
        $('#btnC').text(lang.buttonSet);

        // 単位ラベル更新
        $('#hour').next('.unit-label').text(lang.hourUnit);
        $('#minute').next('.unit-label').text(lang.minuteUnit);
        $('#second').next('.unit-label').text(lang.secondUnit);

        // 時間表示テキスト更新（如果当前有显示的话）
        $("#time").html(lang.elapsedTime + "0");
        $("#remain").html(lang.remainingTime + "0");
    }

    // ブラウザ言語を検出
    function detectBrowserLanguage() {
        var browserLang = navigator.language || navigator.userLanguage;

        if (browserLang.startsWith('zh')) {
            return 'zh'; // 简体中文
        } else if (browserLang.startsWith('ja')) {
            return 'ja'; // 日文
        } else {
            return 'en'; // 默认英文
        }
    }

    
    // ボタンの初期設定
    function init(){
        // ブラウザ言語を検出して設定
        currentLanguage = detectBrowserLanguage();

        $('#btnA').prop('disabled', false);
        $('#btnC').prop('disabled', false);
        buttonState = 'idle';
        updateButtonText();
        updateAllTexts(); // すべてのテキストを正しい言語で更新
        loadSavedTime(); // localStorageから保存された時間を読み込む

        // 入力検証イベントのバインド
        $('#hour').on('input', validateHour);
        $('#minute').on('input', validateMinute);
        $('#second').on('input', validateSecond);

        // 言語選択器の初期化
        $('#language-select').val(currentLanguage);
        $('#language-select').on('change', function() {
            changeLanguage($(this).val());
        });

        btnCClick(null);
    }

    // Alarmの処理
    function alarm(){
        var canvas = $("#mycanvas")[0];
        var ctx = canvas.getContext("2d");
        var img = new Image(); 　
        img.src = "ksuisbg.gif"; 
        img.onload = function() {
            ctx.drawImage(img, 0, 0, 300, 300); 
        };
        var audio = new Audio();
        audio.src = "pin.wav";　
        audio.play();

        
    }
    
    // ButtonAがクリックされた時の処理
    function btnAClick(e){
        if (buttonState === 'idle') {
            // カウントダウン開始
            active = true;
            if (pausedTime) {
                startTime = new Date() - pausedTime * 1000;
            } else {
                startTime = new Date();
            }
            pausedTime = 0;
            buttonState = 'running';
            $("#btnA").prop('disabled', false);
            $("#btnC").prop('disabled', true);
        } else if (buttonState === 'running') {
            // カウントダウン一時停止
            active = false;
            pausedTime = etime;
            buttonState = 'paused';
            $("#btnA").prop('disabled', false);
            $("#btnC").prop('disabled', false);
        } else if (buttonState === 'paused') {
            // カウントダウン再開
            active = true;
            startTime = new Date() - pausedTime * 1000;
            pausedTime = 0;
            buttonState = 'running';
            $("#btnA").prop('disabled', false);
            $("#btnC").prop('disabled', true);
        }
        updateButtonText();
    }


    // ButtonCがクリックされた時の処理
    function btnCClick(e){
        saveTimeToStorage(); // 現在の設定時間をlocalStorageに保存
        alarm();
        active = false;
        pausedTime = 0;
        buttonState = 'idle';
        updateButtonText();
        updateAllTexts(); // すべてのテキストを更新
        period = 3600 * parseInt( $("#hour").val() ) + 60 * parseInt( $("#minute").val() ) + parseInt( $("#second").val() );
    }
    
 
    // 繰り返し実行する処理
    function timer(){  
        if (active) {
            etime = parseInt( (new Date() - startTime)/1000 );
            rest = period - etime;　
            var lang = languages[currentLanguage];
            $("#time").html(lang.elapsedTime + etime);
            var hours = Math.floor(rest / 3600);
            var minutes = Math.floor((rest % 3600) / 60);
            var seconds = rest % 60;
            var timeString = "";
            if (currentLanguage === 'zh') {
                if (hours > 0) {
                    timeString += hours + "小时 ";
                }
                timeString += minutes + "分 " + seconds + "秒";
            } else if (currentLanguage === 'ja') {
                if (hours > 0) {
                    timeString += hours + "時間 ";
                }
                timeString += minutes + "分 " + seconds + "秒";
            } else {
                if (hours > 0) {
                    timeString += hours + "h ";
                }
                timeString += minutes + "m " + seconds + "s";
            }
            $("#remain").html(lang.remainingTime + rest + "（" + timeString + "）");
            analog(rest);
            if (rest <= 0) {
                alarm();
                active = false;
                buttonState = 'idle';
                updateButtonText();
                $("#btnA").prop('disabled', false);
                $("#btnC").prop('disabled', false);
            }
 
 }
        
    } 

  </script>
</head>
<body>
    <canvas id="mycanvas" width="200" height="200">Test</canvas>

    <div id="hourStr">〇</div>
    <div id="minuteStr">〇</div>
    <div id="secondStr">〇</div>

    <div id="remain">残り時間：</div>
    <div id="time">経過時間：</div>
    <button id="btnA">開始</button>
    <button id="btnC">セット</button>
    <div id="input-container">
        <div class="input-group">
            <input type="number" id="hour" value=0 min="0" max="11" >
            <span class="unit-label">時</span>
        </div>
        <div class="input-group">
            <input type="number" id="minute" value=3 min="0" max="59" >
            <span class="unit-label">分</span>
        </div>
        <div class="input-group">
            <input type="number" id="second" value=0 min="0" max="59" >
            <span class="unit-label">秒</span>
        </div>
    </div>

    <!-- 言語選択器 -->
    <div id="language-selector">
        <select id="language-select">
            <option value="zh">中文</option>
            <option value="ja">日本語</option>
            <option value="en">English</option>
        </select>
    </div>
</body>
</html>
